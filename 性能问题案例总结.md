# 1 CPU
当CPU资源成为系统性能的瓶颈时，一般都会表现出下面的症状：  
（1）很慢的响应时间；  
（2）CPU空闲时间为零；
（3）过高的用户占用CPU时间；
（4）过高的系统占用CPU时间；
（5）长时间有很长的运行进程队列
如果系统出现了上面类似症状，一般是CPU性能资源被利用完，但是并非一定是由于CPU资源不够引起的，事实上，有些症状的出现很可能是由于其他资源的不足引起的，如内存不够时，CPU会忙内存管理的事，这时从表面上来看， CPU的利用率是100%，实际上用户程序真正使用的CPU时间很少。

## 1.1 us过高
1. 总体思路就是找热点函数，然后对热点函数有针对性的优化。
   - 方法1：查到占用CPU过高的线程，然后打出调用该线程调用栈，找出热点函数。
     - 先用ps –efL命令查看进程各个线程那个cpu占用率过高，然后再gdb attach到进程上，用thread apply all bt打印出所有线程调用栈，就可以看到具体的那个函数cpu占用率过高了。
     - 或：先用top–H–p xxxx(进程号)查看哪个线程CPU占用率过高，然后再gstack xxxx( 进程号)输出调用栈，找到对应的线程，即可找到热点函数。

   - 方法2：利用工具找出热点函数
     - Oprofile
     - perf

2. TCU案例
   测试发现TCU0核的CPU us值过高，超过50%，理论0核的CPU不会超过30%。
   首先确定是TCU进程占用的CPU高引起CPU 0核的us值过高，然后利用Oprofile/Perf 工具找出热点函数，针对业务流程，修改代码优化。

## 1.2 sy过高
1. sy的值表示是内核的消耗，如果出现sy的值过高，不要先去考虑是内核的问题，先查看是不是内存不足，是不是磁盘满，是不是IO的问题，就是说先考虑自己进程的问题，比方是否IO引起的问题，是否网络引起的问题的。
   - 方法1：排查系统IO或者网络等是否已经到瓶颈了。
   - 方法2：同us过高的方法，排查是哪个系统调用引起的sy值过高。

2. TCU案例一：TCU进程的文件句柄泄露，跑性能一晚上后，导致CPU的sy值过高。
   TCU进程没有删除转码后的文件，测试脚本删除了转码后的文件。Linux下文件被删除后，空间没有被释放，最后导致没有空间可用，出现sy值过高。

   在Linux或者Unix系统中，通过rm或者文件管理器删除文件将会从文件系统的目录结构上解除链接(unlink)，然而如果文件是被打开的（有一个进程正在使用），那么进程将仍然可以读取该文件，磁盘空间也一直被占用。

   用lsof | grep deleted命令可以查看是不是文件句柄泄露。

3. TCU案例二：同时kill -6 所有转码进程后，单板很慢，CPU sy值过高。
   8个转码进程杀了后，会立即生成8个core文件，8个core文件有80G，IO操作非常频繁，导致sy值过高。

## 1.3 wa过高
1. CPU的wa值表示等待IO的时间，包括idle时间。(wa的值高时，说明IO等待比较严重，这可能由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈（块操作）wa列显示了IO等待所占用的CPU时间的百分比。这里wa的参考值为30%，如果wa超过30%，说明IO等待严重，这是磁盘大量随机访问造成的，也可能磁盘或者磁盘访问控制器的贷款瓶颈造成的，主要是块操作。

2. TCU案例：TCU在跑性能的时候出现wa值过高。
   TCU离线转码用到了NFS，wa的值过高，首先想到是NFS引起的。先确定耗IO较高的进程，用pidstat –d 1 10可以确定是TCU耗wa值较高。

   然后再用iostat -h -n –d命令查看NFS上的流量，发现性能呼叫的时候NFS读流量大约3M/s，写流量大约5.5M/s，总流量不算很大。怀疑是NFS服务器那边的IO慢，或者是网络慢。

   最后用mount命令查看NFS服务器后，登录到NFS服务器查看NFS服务器的性能，发现该NFS服务器没有采用磁阵，读写都是本地磁盘，性能只能如此。

# 2 内存
内存泄露比较常见，TCU也有泄露的案例，这里不细说了。

# 3 IO
## 3.1 文件inode耗尽
1. inode是理解linux文件系统的核心概念。iNode的意思就是index node，就是索引的意思。每个文件和目录都对应着一个inode，inode在一个分区内是唯一的。

   对于文件而言，它的信息可以人为的看成三个部分，文件名，文件属性和文件内容。文件名就是我们通常使用的名字，文件属性则包括文件大小，权限设置，修改时间等。文件内容就是我们用cat命令能看到的东西。文件属性是全部保存在文件对应的inode当中的，文件内容在物理上和inode并不是存放在一起，而是放在稍微靠后的磁盘区，也可以称为数据区。在inode里面有指向数据区的指针。

2. TCU案例：跑转码的时候出现创建转码文件失败。
   用 df –hi 发现磁盘空间是足够的，inode为0了，所以创建文件失败。查看linux日志/var/log/message，查看dmesg，发现原来用了oprofile工具后，没有把该工具关闭，最后该工具把文件inode耗尽，导致转码失败。
   查看文件inode的命令ls –i。

# 4 网络
还未处理过类似的问题。待补充。

